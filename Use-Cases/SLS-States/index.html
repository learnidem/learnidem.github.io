<!doctype html><html lang=en-gb>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SLS States - Learn Idem</title>
<meta name=description content="   Powered by Idem Project">
<meta name=generator content="Hugo 0.92.1">
<link href=https://learnidem.github.io/index.xml rel=alternate type=application/rss+xml>
<link rel=canonical href=https://learnidem.github.io/Use-Cases/SLS-States/>
<link rel=stylesheet href=https://learnidem.github.io/css/theme.css>
<link rel=stylesheet href=/css/lightbox.min.css>
<link rel=stylesheet href=/css/custom.css>
<script src=https://use.fontawesome.com/releases/v5.0.6/js/all.js></script>
<link rel=stylesheet href=https://learnidem.github.io/css/chroma.min.css>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script>
<script src=https://learnidem.github.io/js/bundle.js></script>
<script src=/js/lightbox.min.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8R0DEW1VZM"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-8R0DEW1VZM')</script>
<style>:root{--custom-font-color:#0065ab;--custom-background-color:#FFFFFF}</style>
<meta property="og:title" content="SLS States">
<meta property="og:description" content="   Powered by Idem Project">
<meta property="og:type" content="website">
<meta property="og:url" content="https://learnidem.github.io/Use-Cases/SLS-States/"><meta property="og:image" content="https://learnidem.github.io/images/service-broker.svg"><meta property="og:site_name" content="Learn Idem">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://learnidem.github.io/images/service-broker.svg">
<meta name=twitter:title content="SLS States">
<meta name=twitter:description content="   Powered by Idem Project">
<meta itemprop=name content="SLS States">
<meta itemprop=description content="   Powered by Idem Project"></head>
<body><div class=container><header>
<div class=header-image>
<img src=/images/idem-logo.jpg alt="   Learn Idem">
</div>
<div class=header>
<div class=header-h1>
<h1 class=header-h1> Learn Idem</h1>
</div>
<div class=header-description>
<p class=description> Powered by Idem Project</p>
</div>
</div>
</header>
<div class=content-container>
<main><h1>SLS States</h1><p>States are yaml file definitions with extension <b>SLS</b> <br>
States can be accessed by their relative location in idem-azure-auto/idem_azure_auto/states.<br>
For example, in the <b>State SLS</b> yaml file below, Azure resource group state can be created and subsequently updated with the <a href=/Getting-Started/Basic-Commands/>
Present
</a> state function.</p>
<p>The following examples showcase how to use the available <a href=/Getting-Started/Basic-Commands/>
idem states
</a> to work with Azure Resources.
Make sure to export the encryption key and path to the <i>fernet file</i> as an environment variable as described in the <a href=/Getting-Started/Authenticate/>
authentication section
</a> before trying the commands below</p>
<div class=gdoc-tabs>
<input type=radio class="gdoc-tabs__control hidden" name=tabs-usecases id=tabs-usecases-0 checked>
<label for=tabs-usecases-0 class=gdoc-tabs__label>
Present
</label>
<div class="gdoc-markdown--nested gdoc-tabs__content">
<p>In order to create a new Azure Resource Group, we craft the <b>my_resource_group_state.sls:</b> file with the following contents:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>&lt;Your Azure Resource Group Name&gt;</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>azure.resource_management.resource_groups.present</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>resource_group_name</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Your Azure Resource Group Name&gt;</span><span class=w>
</span><span class=w>  </span>- <span class=nt>parameters</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>location</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Azure Region&gt;</span><span class=w>
</span><span class=w>    </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></code></pre></div><p>We refer first to the Azure Idem Provider&rsquo;s Resource Group - &ldquo;<a href=/Getting-Started/Cloud-Providers/>
azure.resource_management.resource_groups
</a>&rdquo; and we append the state directive <a href=Getting-Started/Basic-Commands/>
present
</a>, for instructing idem to <b>create</b> a new resource group in Azure.</p>
<p>Then <b>State SLS</b> file can be executed with:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem state &lt;file_path&gt;/my_resource_group_state.sls
</code></pre></div><p>In this example:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem state states/my_resource_group_state.sls
</code></pre></div><p>After that you will see Idem appending our tag information to meet our new intentention and state.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>--------
      ID: moff-idem-01
Function: azure.resource_management.resource_groups.present
  Result: True
 Comment: Created
 Changes: new:
    ----------
    id:
        /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/moff-idem-01
    name:
        moff-idem-01
    type:
        Microsoft.Resources/resourceGroups
    location:
        eastus
    tags:
        ----------
    properties:
        ----------
        provisioningState:
            Succeeded
</code></pre></div><p>You can further verify by the <a href=/Use-Cases/Describe/>
idem describe
</a> and <a href=/Use-Cases/Filter-flag/>
filter
</a> by the resource group name.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem describe azure.resource_management.resource_groups  --filter<span class=o>=</span><span class=s2>&#34;[?resource[?resource_group_name==&#39;moff-idem-01&#39;]]&#34;</span>
</code></pre></div><p>State Present:</p>
<script id=asciicast-kZUpVCaDPqkaXUIPP1z4XrG5J src=https://asciinema.org/a/kZUpVCaDPqkaXUIPP1z4XrG5J.js async theme=asciinema data-autoplay=true data-size=small loop=true></script>
<p>The resource parameters in an SLS yaml file follow the exact structure as what’s in the <a href=https://docs.microsoft.com/en-us/rest/api/azure/ target=_blank>
<i class="fa fa-external-link-alt fa-sm" aria-hidden=true></i> Azure REST API doc
</a>.
<b>URI Parameters</b> should be specified in each case with “-” in front. All parameters of the API <b>request body</b> should be specified in exactly the same way as what’s in the <a href=https://docs.microsoft.com/en-us/rest/api/azure/ target=_blank>
<i class="fa fa-external-link-alt fa-sm" aria-hidden=true></i> Azure REST API doc
</a>. Please note that we can use the <a href=Getting-Started/Basic-Commands/>
state describe
</a> for creating SLS files with most parameters.</p>
<p>You can include multiple resources in a single SLS yaml file.
Some resources may have dependencies among them, for that you include <a href=/Use-Cases/reconciler-flag/>
reconciler=basic flag
</a>, This allows Idem-azure-auto to run Idem state
with Idem&rsquo;s reconciliation loop.</p>
</div>
<input type=radio class="gdoc-tabs__control hidden" name=tabs-usecases id=tabs-usecases-1>
<label for=tabs-usecases-1 class=gdoc-tabs__label>
Present (Update)
</label>
<div class="gdoc-markdown--nested gdoc-tabs__content">
<p>We can also use the state directive <a href=Getting-Started/Basic-Commands/>
present
</a>, for instructing Idem to <b>update</b> an existing resource&rsquo;s properties or behavior, e.g. updating specific resource parameters such as : location, tags, addressprefix, etc.</p>
<p>Please note that due to the nature of some resources, the only way to update parameters or behaviors is by re-creating them, in those scenarios you can include the <a href=/Use-Cases/Force-Update/>
force_update: True
</a> flag for enforcing the new present goal state.</p>
<p>Let&rsquo;s update the <b>tags</b> information for an existing Azure Resource Group, in order to do that, we craft the <b>update_my_resource_group_state.sls:</b> file with the following contents:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>&lt;Your Azure Resource Group Name&gt;</span><span class=p>:</span><span class=w>
</span><span class=w> </span><span class=nt>azure.resource_management.resource_groups.present</span><span class=p>:</span><span class=w>
</span><span class=w> </span>- <span class=nt>resource_group_name</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Your Azure Resource Group Name&gt;</span><span class=w>
</span><span class=w> </span>- <span class=nt>parameters</span><span class=p>:</span><span class=w>
</span><span class=w>   </span><span class=nt>location</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Azure Region&gt;</span><span class=w>
</span><span class=w>   </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span>{<span class=nt>&#34;createdWith&#34;: </span><span class=s2>&#34;idem&#34;</span>}<span class=w>
</span></code></pre></div><p>We added just the code line: <b>tags: {&ldquo;createdWith&rdquo;: &ldquo;idem&rdquo;}</b>
Then <b>State SLS</b> file can be executed with:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem state &lt;file_path&gt;/update_my_resource_group_state.sls
</code></pre></div><p>In this example:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem state states/update_my_resource_group_state.sls
</code></pre></div><p>After that you will see Idem appending our tag information to meet our new intentention and state.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>--------
      ID: moff-idem-01
Function: azure.resource_management.resource_groups.present
  Result: True
 Comment: OK
 Changes: old:
    ----------
    tags:
        ----------
new:
    ----------
    tags:
        ----------
        createdWith:
            idem

</code></pre></div><p>You can further verify by the <a href=/Use-Cases/Describe/>
idem describe
</a> and <a href=/Use-Cases/Filter-flag/>
filter
</a> by the resource group name.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem describe azure.resource_management.resource_groups  --filter<span class=o>=</span><span class=s2>&#34;[?resource[?resource_group_name==&#39;moff-idem-01&#39;]]&#34;</span>
</code></pre></div><p>State Present - Update (tags):</p>
<script id=asciicast-U0TBeuu6e5w8oWVoIhXe6q1cx src=https://asciinema.org/a/U0TBeuu6e5w8oWVoIhXe6q1cx.js async theme=asciinema data-autoplay=true data-size=small loop=true></script>
</div>
<input type=radio class="gdoc-tabs__control hidden" name=tabs-usecases id=tabs-usecases-2>
<label for=tabs-usecases-2 class=gdoc-tabs__label>
Absent
</label>
<div class="gdoc-markdown--nested gdoc-tabs__content">
<p>Once you don&rsquo;t need a resource, you can completely delete it by using the state directive <a href=Getting-Started/Basic-Commands/>
absent
</a>, which instructs Idem to <b>remove</b> an existing resource.</p>
<p>Let&rsquo;s delete an existing Azure Resource Group, in order to do that, we craft the <b>delete_my_resource_group_state.sls:</b> file with the following contents:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>&lt;Your Azure Resource Group Name&gt;</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>azure.resource_management.resource_groups.absent</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>resource_group_name</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Your Azure Resource Group Name&gt;</span><span class=w>
</span><span class=w>  </span>- <span class=nt>parameters</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>location</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Azure Region&gt;</span><span class=w>
</span></code></pre></div><p>Then <b>State SLS</b> file can be executed with:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem state &lt;file_path&gt;/delete_my_resource_group_state.sls
</code></pre></div><p>In this example:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem state states/delete_my_resource_group_state.sls
</code></pre></div><p>After that you will see Idem removing the resource group to meet our new intentention and state.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>--------
      ID: moff-idem-01
Function: azure.resource_management.resource_groups.absent
  Result: True
 Comment: Accepted
 Changes: old:
    ----------
    id:
        /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/moff-idem-01
    name:
        moff-idem-01
    type:
        Microsoft.Resources/resourceGroups
    location:
        eastus
    tags:
        ----------
        createdWith:
            idem
    properties:
        ----------
        provisioningState:
            Succeeded
</code></pre></div><p>You can further verify by the <a href=/Use-Cases/Describe/>
idem describe
</a> and <a href=/Use-Cases/Filter-flag/>
filter
</a> by the resource group name.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem describe azure.resource_management.resource_groups  --filter<span class=o>=</span><span class=s2>&#34;[?resource[?resource_group_name==&#39;moff-idem-01&#39;]]&#34;</span>
</code></pre></div><p>State Absent - Delete:</p>
<script id=asciicast-obpjtrBTOr3A4cDo5kNEdQLXt src=https://asciinema.org/a/obpjtrBTOr3A4cDo5kNEdQLXt.js async theme=asciinema data-autoplay=true data-size=small loop=true></script>
</div>
<input type=radio class="gdoc-tabs__control hidden" name=tabs-usecases id=tabs-usecases-3>
<label for=tabs-usecases-3 class=gdoc-tabs__label>
Describe 2 State
</label>
<div class="gdoc-markdown--nested gdoc-tabs__content">
<p>You probably noticed that when you execute a <a href=/Use-Cases/Describe/>
describe
</a> operation fron CLI, the output resembles the same kind of data we have defined in SLS states examples, that is because it is exactly the same, meaning, you don&rsquo;t need to start from scratch to create, modify or even delete resources, you can simply issue the <a href=/Use-Cases/Describe/>
describe
</a> operation and save the output into an SLS file then &ldquo;tweak&rdquo; accordingly to meet your intention.</p>
<p>Let&rsquo;s say we want to add a new Azure resource group, for that I could simply describe an existing &ldquo;Azure Resource Group Name&rdquo; and save the output into a SLS file.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell> idem describe azure.resource_management.resource_groups --filter<span class=o>=</span><span class=s2>&#34;[?resource[?vm_name==&#39;&lt;Existing Azure Resource Group Name&gt;&#39;]]&#34;</span> &gt;&gt; &lt;states folder&gt;/my_other_resource_group_state.sls
</code></pre></div><p>Then we can edit the file, removing any property we don&rsquo;t need, &ldquo;Provison States&rdquo; sentences and &ldquo;ID&rdquo; entries, inlcuding any long names with specific &ldquo;IDs&rdquo;, as they are generated by the system, then updating the relevant ones, such as the name or the region, or any parameter associated to the new resource<br>
Please note, that when editing, you always need to include the minimum parameters to create any given resource (Azure Provider Documentation and even Azure Cloud API documentation provides details in this regard).</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>&lt;New Azure Resource Group Name&gt;</span><span class=p>:</span><span class=w>
</span><span class=w> </span><span class=nt>azure.resource_management.resource_groups.present</span><span class=p>:</span><span class=w>
</span><span class=w> </span>- <span class=nt>resource_group_name</span><span class=p>:</span><span class=w> </span><span class=l>&lt;New Azure Resource Group Name&gt;</span><span class=w>
</span><span class=w> </span>- <span class=nt>parameters</span><span class=p>:</span><span class=w>
</span><span class=w>     </span><span class=nt>location</span><span class=p>:</span><span class=w> </span><span class=l>eastus</span><span class=w>
</span><span class=w>     </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>&lt;New Azure Resource Group Name&gt;</span><span class=w>
</span><span class=w>     </span><span class=nt>properties</span><span class=p>:</span><span class=w>
</span><span class=w>     </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span><span class=w>       </span>{<span class=nt>createdWith</span><span class=p>:</span><span class=w> </span><span class=l>idem}</span><span class=w>
</span><span class=w>     </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Microsoft.Resources/resourceGroups</span><span class=w>
</span></code></pre></div><p>Of course you can use an existing SLS File, e,g. you may have all your Resource Groups in one single SLS State file.
Please make sure to indicate the state directive <a href=Getting-Started/Basic-Commands/>
present
</a>, for instructing idem to <b>create</b> a new resource group in Azure.</p>
<p>Then <b>State SLS</b> file can be executed with:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem state &lt;file_path&gt;/my_other_resource_group_state.sls
</code></pre></div><p>In this example:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem state states/my_other_resource_group_state.sls
</code></pre></div><p>After that you will see Idem creating a new resource to meet our new intentention and state.</p>
<p>State &ldquo;Describe 2 State&rdquo;:</p>
<script id=asciicast-Kt6u7T78eZnRAgkfgzy86ggen src=https://asciinema.org/a/Kt6u7T78eZnRAgkfgzy86ggen.js async theme=asciinema data-autoplay=true data-size=small loop=true></script>
</div>
<input type=radio class="gdoc-tabs__control hidden" name=tabs-usecases id=tabs-usecases-4>
<label for=tabs-usecases-4 class=gdoc-tabs__label>
Basic End to End Azure Virtual Machine
</label>
<div class="gdoc-markdown--nested gdoc-tabs__content">
<p>This example showcases how to create a basic Azure Virtual Machine, we will create the Resource Group, Re-Use an existing NIC and create the Azure Virtual Machine resource then we could update the metadata:</p>
<p>We will use <a href=/Getting-Started/Basic-Commands/>
describe
</a> command to verify we don&rsquo;t have an existing Azure VM</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem describe azure.compute.virtual_machines
</code></pre></div><p>You should get empty brackets</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=o>{}</span>
</code></pre></div><p>Let&rsquo;s first create an Azure Resource Group named &ldquo;moff-idem-01&rdquo;</p>
<p>We can do it by writing the following state <b>&ldquo;rg_moff_present.sls&rdquo;</b>
that includes the idem <a href=/Getting-Started/Basic-Commands/>
present
</a> directive for <b>azure.resource_management.resource_groups</b></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>moff-idem-01:
  azure.resource_management.resource_groups.present:
  - resource_group_name: moff-idem-01
  - parameters:
      location: eastus
      tags: <span class=o>{}</span>
</code></pre></div><p>Then we can simply execute it by calling the command &ldquo;state&rdquo;</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem state rg_moff_present.sls
</code></pre></div><p>This will return the following output (please note the provisioningState):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>--------
      ID: moff-idem-01
Function: azure.resource_management.resource_groups.present
  Result: True
 Comment: Created
 Changes: new:
    ----------
    id:
        /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/moff-idem-01
    name:
        moff-idem-01
    type:
        Microsoft.Resources/resourceGroups
    location:
        eastus
    tags:
        ----------
    properties:
        ----------
        provisioningState:
            Succeeded
</code></pre></div><p>If we re-run the same &ldquo;state&rdquo; command, it will indicate that indeed the resource is present, and that nothing changed since we didn&rsquo;t introduce any modifications to the state file.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>--------
      ID: moff-idem-01
Function: azure.resource_management.resource_groups.present
  Result: True
 Comment: <span class=s1>&#39;moff-idem-01&#39;</span> has no property need to be updated.
 Changes: 
</code></pre></div><p>Now, in order to create a Azure VM, we will need to indicate the &ldquo;networkInterfaces id&rdquo;</p>
<p>We can create it also with &ldquo;idem virtual_networks&rdquo; or we could re-use an existing one by discovering with the &ldquo;idem describe&rdquo; command for &ldquo;virtual_networks&rdquo; resources:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem describe azure.virtual_networks.network_interfaces
</code></pre></div><p>In this case, the output of the command shows this network interface available</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>--------
? /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/group8a87dd00ea7183a729588634c88e5123/providers/Microsoft.Network/networkInterfaces/default
: azure.virtual_networks.network_interfaces.present:
  - network_interface_name: default
  - resource_group_name: group8a87dd00ea7183a729588634c88e5123
  - parameters:
      etag: W/6f33dd08-64fa-4d11-8c17-2d9fdea97671
      <span class=s2>&#34;id: /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/group8a87dd00ea7183a729588634c88e5123/providers/Microsoft.Network/networkInterfaces/default&#34;</span>
      location: centralus
      name: default
      properties:
        dnsSettings:
          appliedDnsServers: <span class=o>[]</span>
          dnsServers: <span class=o>[]</span>
        enableAcceleratedNetworking: <span class=nb>false</span>
        enableIPForwarding: <span class=nb>false</span>
        hostedWorkloads: <span class=o>[]</span>
        ipConfigurations:
        - etag: W/6f33dd08-64fa-4d11-8c17-2d9fdea97671
          id: /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/group8a87dd00ea7183a729588634c88e5123/providers/Microsoft.Network/networkInterfaces/default/ipConfigurations/nicconfig8a87dd00ea7183a729588634c88e5123
          name: nicconfig8a87dd00ea7183a729588634c88e5123
          properties:
            primary: <span class=nb>true</span>
            privateIPAddress: 10.0.0.8
            privateIPAddressVersion: IPv4
            privateIPAllocationMethod: Dynamic
            provisioningState: Succeeded
            publicIPAddress:
              id: /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/group8a87dd00ea7183a729588634c88e5123/providers/Microsoft.Network/publicIPAddresses/VNF-Primary-CSCF-1-002668-pip
            subnet:
              id: /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/Moff-RG01-CAS/providers/Microsoft.Network/virtualNetworks/vNet1-MoffCAS01/subnets/default
          type: Microsoft.Network/networkInterfaces/ipConfigurations
        macAddress: 00-0D-3A-A5-4A-E9
        networkSecurityGroup:
          id: /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/Moff-RG01-CAS/providers/Microsoft.Network/networkSecurityGroups/Moff-CAS-Default
        nicType: Standard
        provisioningState: Succeeded
        resourceGuid: 33b57d86-1cfd-4c05-9772-92cfcc1e0f6c
        tapConfigurations: <span class=o>[]</span>
        vnetEncryptionSupported: <span class=nb>false</span>
</code></pre></div><p>Now, let&rsquo;s write a new state <b>&ldquo;vm_moff_present.sls&rdquo;</b> defining our Azure VM
that includes the idem <a href=/Getting-Started/Basic-Commands/>
present
</a> directive for <b>azure.compute.virtual_machines</b></p>
<p>Also note that included properties needed for creating the Azure VM, such as VM Name, Hardware Profile (Flavor), ImageReference, etc.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>  azure.compute.virtual_machines.present:
  - resource_group_name: moff-idem-01
  - vm_name: Development-idem-015042
  - parameters:
      location: centralus
      name: Development-idem-015042
      properties:
        hardwareProfile:
          vmSize: Standard_A5
        networkProfile:
          networkInterfaces:
          - id: /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/group8a87dd00ea7183a729588634c88e5123/providers/Microsoft.Network/networkInterfaces/default
            properties:
              primary: <span class=nb>true</span>
        storageProfile:
          dataDisks: <span class=o>[]</span>
          imageReference:
            exactVersion: 18.04.201804262
            offer: UbuntuServer
            publisher: Canonical
            sku: 18.04-LTS
            version: 18.04.201804262
        osProfile:
          adminUsername: azureuser
          allowExtensionOperations: <span class=nb>true</span>
          computerName: Development-idem-015042
          adminPassword: <span class=s2>&#34;C@n0n1c@lVMware&#34;</span>
          linuxConfiguration:
            disablePasswordAuthentication: <span class=nb>false</span>
            patchSettings:
              assessmentMode: ImageDefault
              patchMode: ImageDefault
            provisionVMAgent: <span class=nb>true</span>
          secrets: <span class=o>[]</span>
</code></pre></div><p>and just as before when we created our Azure Resource Group, we can simply execute it by calling the command &ldquo;state&rdquo;</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem state vm_moff_present.sls
</code></pre></div><p>This will return the following output (please note the provisioningState):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>--------
      ID: Development-idem-015042
Function: azure.compute.virtual_machines.present
  Result: True
 Comment: Created
 Changes: new:
    ----------
    name:
        Development-idem-015042
    id:
        /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/moff-idem-01/providers/Microsoft.Compute/virtualMachines/Development-idem-015042
    type:
        Microsoft.Compute/virtualMachines
    location:
        centralus
    properties:
        ----------
        vmId:
            1ae9935c-3699-4837-a59d-a2938b24644d
        hardwareProfile:
            ----------
            vmSize:
                Standard_A5
        storageProfile:
            ----------
            imageReference:
                ----------
                publisher:
                    Canonical
                offer:
                    UbuntuServer
                sku:
                    18.04-LTS
                version:
                    18.04.201804262
                exactVersion:
                    18.04.201804262
            osDisk:
                ----------
                osType:
                    Linux
                createOption:
                    FromImage
                caching:
                    ReadWrite
                managedDisk:
                    ----------
                    storageAccountType:
                        Standard_LRS
                deleteOption:
                    Detach
                diskSizeGB:
                    <span class=m>30</span>
            dataDisks:
        osProfile:
            ----------
            computerName:
                Development-idem-015042
            adminUsername:
                azureuser
            linuxConfiguration:
                ----------
                disablePasswordAuthentication:
                    False
                provisionVMAgent:
                    True
                patchSettings:
                    ----------
                    patchMode:
                        ImageDefault
                    assessmentMode:
                        ImageDefault
            secrets:
            allowExtensionOperations:
                True
            requireGuestProvisionSignal:
                True
        networkProfile:
            ----------
            networkInterfaces:
                <span class=p>|</span>_
                  ----------
                  id:
                      /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/group8a87dd00ea7183a729588634c88e5123/providers/Microsoft.Network/networkInterfaces/default
                  properties:
                      ----------
                      primary:
                          True
        <span class=s2>&#34;provisioningState:
</span><span class=s2>            Creating&#34;</span>
</code></pre></div><p>If we re-run the same &ldquo;state&rdquo; command, it will indicate that indeed the resource is present, and that nothing changed since we didn&rsquo;t introduce any modifications to the state file.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>--------
      ID: Development-idem-015042
Function: azure.compute.virtual_machines.present
  Result: True
 Comment: OK
 Changes: old:
    ----------
    properties:
        ----------
        provisioningState:
            Creating
new:
    ----------
    properties:
        ----------
        <span class=s2>&#34;provisioningState:
</span><span class=s2>            Updating&#34;</span>
</code></pre></div><p>At this point if we re-run <a href=/Getting-Started/Basic-Commands/>
describe
</a> command for <b>azure.compute.virtual_machines</b></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem describe azure.compute.virtual_machines
</code></pre></div><p>We get a description for the newly added Azure VM</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>? /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/MOFF-IDEM-01/providers/Microsoft.Compute/virtualMachines/Development-idem-015042
: azure.compute.virtual_machines.present:
  - resource_group_name: MOFF-IDEM-01
  - vm_name: Development-idem-015042
  - parameters:
      id: /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/MOFF-IDEM-01/providers/Microsoft.Compute/virtualMachines/Development-idem-015042
      location: centralus
      name: Development-idem-015042
      properties:
        hardwareProfile:
          vmSize: Standard_A5
        networkProfile:
          networkInterfaces:
          - id: /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/group8a87dd00ea7183a729588634c88e5123/providers/Microsoft.Network/networkInterfaces/default
            properties:
              primary: <span class=nb>true</span>
        osProfile:
          adminUsername: azureuser
          allowExtensionOperations: <span class=nb>true</span>
          computerName: Development-idem-015042
          linuxConfiguration:
            disablePasswordAuthentication: <span class=nb>false</span>
            patchSettings:
              assessmentMode: ImageDefault
              patchMode: ImageDefault
            provisionVMAgent: <span class=nb>true</span>
          requireGuestProvisionSignal: <span class=nb>true</span>
          secrets: <span class=o>[]</span>
        provisioningState: Succeeded
        storageProfile:
          dataDisks: <span class=o>[]</span>
          imageReference:
            exactVersion: 18.04.201804262
            offer: UbuntuServer
            publisher: Canonical
            sku: 18.04-LTS
            version: 18.04.201804262
          osDisk:
            caching: ReadWrite
            createOption: FromImage
            deleteOption: Detach
            diskSizeGB: <span class=m>30</span>
            managedDisk:
              id: /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/moff-idem-01/providers/Microsoft.Compute/disks/Development-idem-015042_OsDisk_1_e6d0942b1250478f86e21be7ed48629b
              storageAccountType: Standard_LRS
            name: Development-idem-015042_OsDisk_1_e6d0942b1250478f86e21be7ed48629b
            osType: Linux
        vmId: 1ae9935c-3699-4837-a59d-a2938b24644d
      type: Microsoft.Compute/virtualMachines
</code></pre></div><p>Now let&rsquo;s update this Azure VM metadata by adding new tags, all we need to do is to update our existing state <b>&ldquo;vm_moff_present.sls&rdquo;</b> by append the property &ldquo;tag&rdquo; at the bottom</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>Development-idem-015042:
  azure.compute.virtual_machines.present:
  - resource_group_name: moff-idem-01
  - vm_name: Development-idem-015042
  - parameters:
      location: centralus
      name: Development-idem-015042
      properties:
        hardwareProfile:
          vmSize: Standard_A5
        networkProfile:
          networkInterfaces:
          - id: /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/group8a87dd00ea7183a729588634c88e5123/providers/Microsoft.Network/networkInterfaces/default
            properties:
              primary: <span class=nb>true</span>
        storageProfile:
          dataDisks: <span class=o>[]</span>
          imageReference:
            exactVersion: 18.04.201804262
            offer: UbuntuServer
            publisher: Canonical
            sku: 18.04-LTS
            version: 18.04.201804262
        osProfile:
          adminUsername: azureuser
          allowExtensionOperations: <span class=nb>true</span>
          computerName: Development-idem-015042
          adminPassword: <span class=s2>&#34;C@n0n1c@lVMware&#34;</span>
          linuxConfiguration:
            disablePasswordAuthentication: <span class=nb>false</span>
            patchSettings:
              assessmentMode: ImageDefault
              patchMode: ImageDefault
            provisionVMAgent: <span class=nb>true</span>
          secrets: <span class=o>[]</span>
      tags:
        blueprintname: goapp-terraform
        deployment: IDEM-Test-Azure
        project: development
</code></pre></div><p>we can, once again, call the command &ldquo;state&rdquo;</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem state vm_moff_present.sls
</code></pre></div><p>This will return the following output (please note the provisioningState):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>--------
      ID: Development-idem-015042
Function: azure.compute.virtual_machines.present
  Result: True
 Comment: OK
 Changes: old:
    ----------
    properties:
        ----------
        provisioningState:
            Succeeded
new:
    ----------
    tags:
        ----------
        blueprintname:
            goapp-terraform
        deployment:
            IDEM-Test-Azure
        project:
            development
    properties:
        ----------
        <span class=s2>&#34;provisioningState:
</span><span class=s2>            Updating&#34;</span>
</code></pre></div><p>And consequently if we re-run <a href=/Getting-Started/Basic-Commands/>
describe
</a> command for <b>azure.compute.virtual_machines</b></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem describe azure.compute.virtual_machines
</code></pre></div><p>We get a description for the newly added Azure VM but this time at the bottom we can see the &ldquo;tag&rdquo; information.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>? /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/MOFF-IDEM-01/providers/Microsoft.Compute/virtualMachines/Development-idem-015042
: azure.compute.virtual_machines.present:
  - resource_group_name: MOFF-IDEM-01
  - vm_name: Development-idem-015042
  - parameters:
      id: /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/MOFF-IDEM-01/providers/Microsoft.Compute/virtualMachines/Development-idem-015042
      location: centralus
      name: Development-idem-015042
      properties:
        hardwareProfile:
          vmSize: Standard_A5
        networkProfile:
          networkInterfaces:
          - id: /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/group8a87dd00ea7183a729588634c88e5123/providers/Microsoft.Network/networkInterfaces/default
            properties:
              primary: <span class=nb>true</span>
        osProfile:
          adminUsername: azureuser
          allowExtensionOperations: <span class=nb>true</span>
          computerName: Development-idem-015042
          linuxConfiguration:
            disablePasswordAuthentication: <span class=nb>false</span>
            patchSettings:
              assessmentMode: ImageDefault
              patchMode: ImageDefault
            provisionVMAgent: <span class=nb>true</span>
          requireGuestProvisionSignal: <span class=nb>true</span>
          secrets: <span class=o>[]</span>
        provisioningState: Succeeded
        storageProfile:
          dataDisks: <span class=o>[]</span>
          imageReference:
            exactVersion: 18.04.201804262
            offer: UbuntuServer
            publisher: Canonical
            sku: 18.04-LTS
            version: 18.04.201804262
          osDisk:
            caching: ReadWrite
            createOption: FromImage
            deleteOption: Detach
            diskSizeGB: <span class=m>30</span>
            managedDisk:
              id: /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/moff-idem-01/providers/Microsoft.Compute/disks/Development-idem-015042_OsDisk_1_e6d0942b1250478f86e21be7ed48629b
              storageAccountType: Standard_LRS
            name: Development-idem-015042_OsDisk_1_e6d0942b1250478f86e21be7ed48629b
            osType: Linux
        vmId: 1ae9935c-3699-4837-a59d-a2938b24644d
      <span class=s2>&#34;tags:
</span><span class=s2>        blueprintname: goapp-terraform
</span><span class=s2>        deployment: IDEM-Test-Azure
</span><span class=s2>        project: development&#34;</span>
      type: Microsoft.Compute/virtualMachines
</code></pre></div><p>And once we don&rsquo;t need this Azure VM and Resource Group</p>
<p>We can do it by writing the following state <b>&ldquo;vm_rg_moff_absent.sls&rdquo;</b>
that includes the idem <a href=/Getting-Started/Basic-Commands/>
absent
</a> directive for <b>azure.resource_management.resource_groups</b> & <b>azure.compute.virtual_machines</b></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>Development-idem-015042:
  azure.compute.virtual_machines.absent:
  - resource_group_name: MOFF-IDEM-01
  - vm_name: Development-idem-015042
  - parameters:
      location: centralus
      name: Development-idem-015042

moff-idem-01:
  azure.resource_management.resource_groups.absent:
  - resource_group_name: moff-idem-01
  - parameters:
      location: eastus

</code></pre></div><p>Then running the command</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem state vm_rg_moff_absent.sls
</code></pre></div><p>This will return the following output (please note the provisioningState):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>--------
      ID: Development-idem-015042
Function: azure.compute.virtual_machines.absent
  Result: True
 Comment: Accepted
 Changes: old:
    ----------
    name:
        Development-idem-015042
    id:
        /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/MOFF-IDEM-01/providers/Microsoft.Compute/virtualMachines/Development-idem-015042
    type:
        Microsoft.Compute/virtualMachines
    location:
        centralus
    tags:
        ----------
        blueprintname:
            goapp-terraform
        deployment:
            IDEM-Test-Azure
        project:
            development
    properties:
        ----------
        vmId:
            1ae9935c-3699-4837-a59d-a2938b24644d
        hardwareProfile:
            ----------
            vmSize:
                Standard_A5
        storageProfile:
            ----------
            imageReference:
                ----------
                publisher:
                    Canonical
                offer:
                    UbuntuServer
                sku:
                    18.04-LTS
                version:
                    18.04.201804262
                exactVersion:
                    18.04.201804262
            osDisk:
                ----------
                osType:
                    Linux
                name:
                    Development-idem-015042_OsDisk_1_e6d0942b1250478f86e21be7ed48629b
                createOption:
                    FromImage
                caching:
                    ReadWrite
                managedDisk:
                    ----------
                    storageAccountType:
                        Standard_LRS
                    id:
                        /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/moff-idem-01/providers/Microsoft.Compute/disks/Development-idem-015042_OsDisk_1_e6d0942b1250478f86e21be7ed48629b
                deleteOption:
                    Detach
                diskSizeGB:
                    <span class=m>30</span>
            dataDisks:
        osProfile:
            ----------
            computerName:
                Development-idem-015042
            adminUsername:
                azureuser
            linuxConfiguration:
                ----------
                disablePasswordAuthentication:
                    False
                provisionVMAgent:
                    True
                patchSettings:
                    ----------
                    patchMode:
                        ImageDefault
                    assessmentMode:
                        ImageDefault
            secrets:
            allowExtensionOperations:
                True
            requireGuestProvisionSignal:
                True
        networkProfile:
            ----------
            networkInterfaces:
                <span class=p>|</span>_
                  ----------
                  id:
                      /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/group8a87dd00ea7183a729588634c88e5123/providers/Microsoft.Network/networkInterfaces/default
                  properties:
                      ----------
                      primary:
                          True
        <span class=s2>&#34;provisioningState:
</span><span class=s2>            Succeeded&#34;</span>
--------
      ID: moff-idem-01
Function: azure.resource_management.resource_groups.absent
  Result: True
 Comment: Accepted
 Changes: old:
    ----------
    id:
        /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/moff-idem-01
    name:
        moff-idem-01
    type:
        Microsoft.Resources/resourceGroups
    location:
        eastus
    tags:
        ----------
    properties:
        ----------
        <span class=s2>&#34;provisioningState:
</span><span class=s2>            Succeeded&#34;</span>
</code></pre></div><p>If we re-run the same &ldquo;state&rdquo; command,</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem state vm_rg_moff_absent.sls
</code></pre></div><p>it will indicate that indeed the resource is already absent or being deleted (some resources take more time to be removed).</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>--------
      ID: Development-idem-015042
Function: azure.compute.virtual_machines.absent
  Result: True
 Comment: <span class=s1>&#39;Development-idem-015042&#39;</span> already absent
 Changes: None
--------
      ID: moff-idem-01
Function: azure.resource_management.resource_groups.absent
  Result: True
 Comment: Accepted
 Changes: old:
    ----------
    id:
        /subscriptions/23a8cee7-a1e4-4bb3-aff9-6898b4ee6fde/resourceGroups/moff-idem-01
    name:
        moff-idem-01
    type:
        Microsoft.Resources/resourceGroups
    location:
        eastus
    tags:
        ----------
    properties:
        ----------
        <span class=s2>&#34;provisioningState:
</span><span class=s2>            Deleting&#34;</span>
</code></pre></div><p>One more time</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>idem state vm_rg_moff_absent.sls
</code></pre></div><p>And both Azure resources are removed or absent</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>--------
      ID: Development-idem-015042
Function: azure.compute.virtual_machines.absent
  Result: True
 Comment: <span class=s1>&#39;Development-idem-015042&#39;</span> already absent
 Changes: None
--------
      ID: moff-idem-01
Function: azure.resource_management.resource_groups.absent
  Result: True
 Comment: <span class=s1>&#39;moff-idem-01&#39;</span> already absent
 Changes: None
</code></pre></div><p>Some resources may have dependencies among them, for that you include <a href=/Use-Cases/reconciler-flag/>
reconciler=basic flag
</a>, This allows Idem-azure-auto to run Idem state
with Idem&rsquo;s reconciliation loop.</p>
</div>
</div>
<div class=edit-meta>
Last updated on 31 Jan 2022
<br><a href=https://github.com/cmbu-tmm-sites/learnidem/edit/main/content/Use%20Cases/SLS%20States/_index.md class=edit-page><i class="fas fa-pen-square"></i>&nbsp;Edit on GitHub</a></div><nav class=pagination><a class="nav nav-prev" href=https://learnidem.github.io/Use-Cases/Describe/ title="Describe command"><i class="fas fa-arrow-left" aria-hidden=true></i>&nbsp;Prev - Describe command</a>
<a class="nav nav-next" href=https://learnidem.github.io/Use-Cases/Filter-flag/ title="Filter Flag">Next - Filter Flag <i class="fas fa-arrow-right" aria-hidden=true></i></a>
</nav><footer><p class=powered>Powered by <a href=https://gohugo.io>Hugo</a>. Theme adapted from <a href=https://github.com/thingsym/hugo-theme-techdoc>Thingsym</a>.</p>
</footer>
</main>
<div class=sidebar>
<nav class=slide-menu>
<ul>
<li><a href=https://learnidem.github.io>Home</a></li>
<li class=has-sub-menu><a href=https://learnidem.github.io/Getting-Started/>Getting Started<span class="mark closed">+</span></a>
<ul class=sub-menu>
<li><a href=https://learnidem.github.io/Getting-Started/Install-Idem/>Install Idem</a>
</li>
<li><a href=https://learnidem.github.io/Getting-Started/Cloud-Providers/>Cloud Providers</a>
</li>
<li><a href=https://learnidem.github.io/Getting-Started/Authenticate/>Authenticate</a>
</li>
<li><a href=https://learnidem.github.io/Getting-Started/Basic-Commands/>Basic Commands</a>
</li>
<li><a href=https://learnidem.github.io/Getting-Started/Troubleshooting/>Troubleshooting</a>
</li>
</ul>
</li>
<li class="parent has-sub-menu"><a href=https://learnidem.github.io/Use-Cases/>Use Cases<span class="mark opened">-</span></a>
<ul class=sub-menu>
<li><a href=https://learnidem.github.io/Use-Cases/Describe/>Describe command</a>
</li>
<li class="parent active"><a href=https://learnidem.github.io/Use-Cases/SLS-States/>SLS States</a>
</li>
<li><a href=https://learnidem.github.io/Use-Cases/Filter-flag/>Filter Flag</a>
</li>
<li><a href=https://learnidem.github.io/Use-Cases/reconciler-flag/>Reconcilier Flag</a>
</li>
<li><a href=https://learnidem.github.io/Use-Cases/Force-Update/>Force Update</a>
</li>
</ul>
</li>
<li><a href=https://learnidem.github.io/Developer-Resources/>Developer Resources</a>
</li>
</ul>
</nav>
<div class=sidebar-footer></div>
</div>
</div><a href=# id=backtothetop-fixed class=backtothetop data-backtothetop-duration=600 data-backtothetop-easing=easeOutQuart data-backtothetop-fixed-fadein=1000 data-backtothetop-fixed-fadeout=1000 data-backtothetop-fixed-bottom=10 data-backtothetop-fixed-right=20>
<span class="fa-layers fa-fw">
<i class="fas fa-circle"></i>
<i class="fas fa-arrow-circle-up"></i>
</span></a>
</div>
</body>
</html>